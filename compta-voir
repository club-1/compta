#!/bin/bash

usage () {
    cat <<'EOF'
 __             ,                    
/  ` _ ._ _ ._ -+- _. ___ .  , _ *._.
\__.(_)[ | )[_) | (_]      \/ (_)|[  

Usage: compta-voir [OPTION]...

-a ACCOUNT    filter using given account name
-b            Output the balance only
-c CATEGORY   filter using one of the following category: don|infra|adhesion|autre
-x            filter checked
-u            filter unchecked
-t            output TSV without headers

-h            print this help

Source code: <https://github.com/club-1/compta>
EOF
}

output='pretty'

data=$(cat /var/compta/transactions.tsv)

while getopts 'a:bc:tuxh' opt
do
    case $opt in
        a)
            name="$OPTARG"
            data=$(echo "$data" | awk -F $'\t' -v name="$name" '$4 ~ name')
        ;;

        b)
            output='balance'
        ;;

        c)
            if [ "$OPTARG" = 'don' ] || [ "$OPTARG" = 'infra' ] || [ "$OPTARG" = 'adhesion' ] || [ "$OPTARG" = 'autre' ]
            then
                category="$OPTARG"
                data=$(echo "$data" | awk -F $'\t' -v category="$category" '$6==category')
            else
                echo "invalid category argument '${OPTARG}'"
                exit 1
            fi
        ;;
        
        t)
            output='tsv'
        ;;

        u)
            data=$(echo "$data" | awk -F $'\t' '$5==""')
        ;;

        x)
            data=$(echo "$data" | awk -F $'\t' '$5=="x"')
        ;;

        h)
            usage
            exit
		;;
        
        ?)
            usage
            exit 1
		;;
    esac
done

# shift "$(($OPTIND -1))"


case $output in
    'tsv')
        echo "$data"
        exit
    ;;

    'balance')
        echo "$data" | cut -f 3 | awk '{t=t+$1} END{print t}'
        exit
    ;;

    'pretty')
        echo "$data" | column -N id,date,montant,compte,effectué,catégorie,intitulé -ts $'\t'
        exit
    ;;
esac
