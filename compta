#!/bin/bash

cat <<-EOF

  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó v1.3    
 ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó    
 ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë    
 ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë    
 ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë        ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë    
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù        ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù de CLUB1   

Documentation : <https://club1.fr/docs/fr/outils/compta.html>
EOF

export PS3="Entrez le num√©ro correspondant :"



voir() {
    echo 'üè∑Ô∏è  Quelle cat√©gorie ?'
    select filtercategory in 'tout' 'adhesion' 'infra' 'don' 'autre'
    do
        echo '--------------------------------------------------'
        if [[ $REPLY -ne 1 ]]
        then
            category="$filtercategory"
        fi

    break
    done


    accounts=('tout')
    readarray -t -s1 -O1 accounts <<< $(cut -f 4 /var/compta/transactions.tsv | sort -u)
    echo 'üë• Voulez vous filtrer les comptes ?'
    select filteraccount in "${accounts[@]}"
    do
        echo '--------------------------------------------------'
        if [[ $REPLY -ne 1 ]]
        then
            account="$filteraccount"
        fi

    break
    done


    echo 'üî© Options suppl√©mentaires'
    select option in 'non' 'effectu√©' 'non effectu√©'
    do
        echo '--------------------------------------------------'
        case $option in
            'effectu√©')
                check='x'
            ;;

            'non effectu√©')
                check='u'
            ;;
        esac
    break
    done

    cat <<EOF

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê 
‚îÇ           üí∞Ô∏è           T R A N S A C T I O N S             üìà            ‚îÇ 
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò 

EOF

    args=()

    if test -n "$category"
    then
        args+=('-c' "$category")
        echo "üóÇÔ∏è  parmis la cat√©gorie '$category'"
    fi

    if test -n "$account"
    then
        args+=('-a' "$account")
        echo "üë• vers le compte de $account"
    fi

    if test -n "$check"
    then
        args+=("-$check")
        echo "‚úÖ $option"
    fi

    args+=('-t')
    data=$(compta-voir "${args[@]}")

    echo
    echo "$data" | column -N id,date,montant,compte,effectu√©,cat√©gorie,intitul√© -ts $'\t'
    echo
    echo -e "‚öñÔ∏è  \033[1mbalance :\033[00m"
    echo "$data" | cut -f 3 | awk '{t=t+$1} END{print t}'
    echo
}


ajouter () {
    args=()

    echo "üìù C'est parti pout ajouter une nouvelle transaction !"
    echo '==================================================='
    echo '(Vous pouvez annuler √† tout moment en tapant CTRL + C)'

    echo "üìÖ √† quelle date ? (au format YYYY-MM-DD) lasser vide pour aujourd'hui"
    read date
    if test -z date
    then
        args+=('-d' "$date")
    fi

    echo "üí∂ Quel montant ? (indiquer + ou - devant le nombre)"
    read argent
    args+=('-m' "$argent")

    echo "üí∞ compte ayant re√ßu l'argent ?"
    accounts=('on ne sait pas encore' 'cr√©er un nouveau compte')
    readarray -t -s1 -O2 accounts <<< $(cut -f 4 /var/compta/transactions.tsv | sort -u)
    select account in "${accounts[@]}"
    do echo "vous avez choisi $account"
    break
    done
    if test "$account" != 'on ne sait pas encore'
    then
        if test "$account" == 'cr√©er un nouveau compte'
        then
            echo 'üë§ nom du nouveau compte ?'
            read account
        fi
        args+=('-a' "$account")
    fi

    echo "‚úÖ le paiement a-t-il √©t√© effectu√© ? (oui/non)"
    read effectue
    case $effectue in
        yes | oui | o | y)
            args+=('-x')
            echo 'effectu√©'
        ;;

        *)
            echo 'pas encore effectu√©'
        ;;
    esac

    echo "üóÇÔ∏è  Quelle cat√©gorie ?"
    select categorie in adhesion infra don autre
    do echo "vous avez choisi $categorie"
    break
    done
    args+=('-c' "$categorie")

    echo "üè∑Ô∏è  intitul√© ?"
    read info
    args+=('-i' "$info")

    echo 'üßæ R√©sum√© de la transaction :'
    compta-ajouter "${args[@]}"

    case $? in
        0)
            echo "‚ú® Transaction ajout√©e ! Merci $USER et bonne journ√©e"
            ;;
        130)
            echo "üóëÔ∏è  transaction annul√©e"
            ;;
        *)
            echo "‚õîÔ∏è Erreur lors de l'ajout de la transaction"
            ;;
    esac

}

effectuer () {
    args=()

    echo '‚ö°Ô∏è quelle transaction voulez vous marquer comme effectu√©e ? (√©crire son num√©ro identifiant)'
    read id
    args+=("$id")

    echo "üí∞ compte ayant re√ßu l'argent ?"
    accounts=('cr√©er un nouveau compte')
    readarray -t -s1 -O1 accounts <<< $(cut -f 4 /var/compta/transactions.tsv | sort -u)
    select account in "${accounts[@]}"
    do echo "vous avez choisi $account"
    break
    done
    if test "$account" == 'cr√©er un nouveau compte'
    then
        echo 'üë§ nom du nouveau compte ?'
        read account
    fi
    args+=("$account")
    compta-effectuer "${args[@]}"
    case $? in
        0)
            echo "‚ú® Transaction effectu√©e ! Merci $USER et bonne journ√©e"
        ;;

        *)
            echo "‚õîÔ∏è Erreur lors de la modification de la transaction"
            ;;
    esac
}


echo "üõéÔ∏è  Bienvenue $USER. Que voulez vous faire ?"
select action in 'voir les comptes' 'ajouter une transaction' 'marquer une transaction comme effectu√©e' 'quitter'
do
    echo '--------------------------------------------------'
    case $action in

        'voir les comptes')
            voir
        ;;

        'ajouter une transaction')
            if id -nG "$USER" | grep -qw 'compta'
            then
                ajouter
            else
                echo "D√©sol√©, c'est impossible üòü"
                echo "Pour ajouter une transaction, il faut √™tre membre du groupe 'compta'"
            fi

            
        ;;

        'marquer une transaction comme effectu√©e')
            if id -nG "$USER" | grep -qw 'compta'
            then
                effectuer
            else
                echo "D√©sol√©, c'est impossible üòü"
                echo "Pour effectuer une transaction, il faut √™tre membre du groupe 'compta'"
            fi

            
        ;;

        'quitter')
        echo 'üëã √Ä la prochaine !'

    esac


break
done
