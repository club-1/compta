#!/bin/bash

cat <<-EOF

  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     
 â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    
 â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘    
 â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘    
 â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘        â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    
  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•šâ•â•        â•šâ•â•   â•šâ•â•  â•šâ•â• de CLUB1   

EOF

export PS3="Entrez le numÃ©ro correspondant :"



voir() {
    echo 'ğŸ·ï¸  Quelle catÃ©gorie ?'
    select filtercategory in 'tout' 'adhesion' 'infra' 'don' 'autre'
    do
        echo '--------------------------------------------------'
        if [[ $REPLY -ne 1 ]]
        then
            category="$filtercategory"
        fi

    break
    done


    accounts=('tout')
    readarray -t -s1 -O1 accounts <<< $(cut -f 4 /var/compta/transactions.tsv | sort -u)
    echo 'ğŸ‘¥ Voulez vous filtrer les comptes ?'
    select filteraccount in "${accounts[@]}"
    do
        echo '--------------------------------------------------'
        if [[ $REPLY -ne 1 ]]
        then
            account="$filteraccount"
        fi

    break
    done


    echo 'ğŸ”© Options supplÃ©mentaires'
    select option in 'non' 'effectuÃ©' 'non effectuÃ©'
    do
        echo '--------------------------------------------------'
        case $option in
            'effectuÃ©')
                check='x'
            ;;

            'non effectuÃ©')
                check='u'
            ;;
        esac
    break
    done

    cat <<EOF

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
â”‚           ğŸ’°ï¸           T R A N S A C T I O N S             ğŸ“ˆ            â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 

EOF

    args=()

    if test -n "$category"
    then
        args+=('-c' "$category")
        echo "ğŸ—‚ï¸  parmis la catÃ©gorie '$category'"
    fi

    if test -n "$account"
    then
        args+=('-a' "$account")
        echo "ğŸ‘¥ vers le compte de $account"
    fi

    if test -n "$check"
    then
        args+=("-$check")
        echo "âœ… $option"
    fi

    args+=('-t')
    data=$(compta-voir "${args[@]}")

    echo
    echo "$data" | column -N id,date,montant,compte,effectuÃ©,catÃ©gorie,intitulÃ© -ts $'\t'
    echo
    echo -e "âš–ï¸  \033[1mbalance :\033[00m"
    echo "$data" | cut -f 3 | awk '{t=t+$1} END{print t}'
    echo
}


ajouter () {
    args=()

    echo "ğŸ“ C'est parti pout ajouter une nouvelle transaction !"
    echo '==================================================='
    echo '(Vous pouvez annuler Ã  tout moment en tapant CTRL + C)'

    echo "ğŸ“… Ã  quelle date ? (au format YYYY-MM-DD) lasser vide pour aujourd'hui"
    read date
    if test -z date
    then
        args+=('-d' "$date")
    fi

    echo "ğŸ’¶ Quel montant ? (indiquer + ou - devant le nombre)"
    read argent
    args+=('-m' "$argent")

    echo "ğŸ’° compte ayant reÃ§u l'argent ?"
    accounts=('on ne sait pas encore' 'crÃ©er un nouveau compte')
    readarray -t -s1 -O2 accounts <<< $(cut -f 4 /var/compta/transactions.tsv | sort -u)
    select account in "${accounts[@]}"
    do echo "vous avez choisi $account"
    break
    done
    if test "$account" != 'on ne sait pas encore'
    then
        if test "$account" == 'crÃ©er un nouveau compte'
        then
            echo 'ğŸ‘¤ nom du nouveau compte ?'
            read account
        fi
        args+=('-a' "$account")
    fi

    echo "âœ… le paiement a-t-il Ã©tÃ© effectuÃ© ? (oui/non)"
    read effectue
    case $effectue in
        yes | oui | o | y)
            args+=('-x')
            echo 'effectuÃ©'
        ;;

        *)
            echo 'pas encore effectuÃ©'
        ;;
    esac

    echo "ğŸ—‚ï¸  Quelle catÃ©gorie ?"
    select categorie in adhesion infra don autre
    do echo "vous avez choisi $categorie"
    break
    done
    args+=('-c' "$categorie")

    echo "ğŸ·ï¸  intitulÃ© ?"
    read info
    args+=('-i' "$info")

    echo 'ğŸ§¾ RÃ©sumÃ© de la transaction :'
    compta-ajouter "${args[@]}"

    case $? in
        0)
            echo "âœ¨ Transaction ajoutÃ©e ! Merci $USER et bonne journÃ©e"
            ;;
        130)
            echo "ğŸ—‘ï¸  transaction annulÃ©e"
            ;;
        *)
            echo "â›”ï¸ Erreur lors de l'ajoute de la transaction"
            ;;
    esac

}



echo "ğŸ›ï¸  Bienvenue $USER. Que voulez vous faire ?"
select action in 'voir les comptes' 'ajouter une transaction' 'quitter'
do
    echo '--------------------------------------------------'
    case $action in

        'voir les comptes')
            voir
        ;;

        'ajouter une transaction')
            if id -nG "$USER" | grep -qw 'compta'
            then
                ajouter
            else
                echo "DÃ©solÃ©, c'est impossible ğŸ˜Ÿ"
                echo "Pour ajouter une transaction, il faut Ãªtre membre du groupe 'compta'"
            fi

            
        ;;

        'quitter')
        echo 'ğŸ‘‹ Ã€ la prochaine !'

    esac


break
done
